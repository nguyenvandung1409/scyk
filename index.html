<!DOCTYPE html>
<html lang="vi">
<head>
    <!-- N·∫øu file ·∫£nh c·ªßa b·∫°n l√† favicon.png -->
    <link rel="icon" href="./favicon.png" type="image/x-icon">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o c√°o s·ª± c·ªë y khoa</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: #f1f5f9; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 10px; }
        .input-field { background: #334155; border: 1px solid #475569; color: white; border-radius: 6px; padding: 8px; width: 100%; }
        .chart-container { position: relative; height: 220px; width: 100%; }
        /* T√πy ch·ªânh thanh cu·ªôn cho b·∫£ng */
        .custom-scroll::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body class="p-2 md:p-3">

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 gap-4 border-b border-slate-700 pb-3">
        <div>
            <h1 class="text-2xl font-bold text-blue-400">H·ªá th·ªëng b√°o c√°o s·ª± c·ªë y khoa</h1>
            <p class="text-1xl font-bold text-green-400">B·ªánh vi·ªán Y h·ªçc c·ªï truy·ªÅn Qu·∫£ng Nam</p>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="app.fetchData()" class="bg-slate-700 hover:bg-slate-600 px-4 py-2 rounded text-sm transition">üîÑ L√†m m·ªõi d·ªØ li·ªáu</button>
            <div class="text-right">
                <p id="current-time" class="text-sm font-mono"></p>
                <span class="text-xs text-green-400">‚óè ƒêang k·∫øt n·ªëi</span>
            </div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
        
        <!-- FORM NH·∫¨P -->
        <div class="card lg:col-span-1 h-fit">
            <h2 class="text-xl font-semibold mb-4 text-blue-300">G·ª¨I B√ÅO C√ÅO M·ªöI</h2>
            <form id="incident-form" class="space-y-4">
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-400 mb-1">Khoa b√°o c√°o</label>
                    <select id="dept" class="input-field">
                        <option>Khoa KB&XN-CƒêHA</option>
                        <option>Khoa N·ªôi</option>
                        <option>Khoa Ngo·∫°i</option>
                        <option>Khoa L√£o</option>
                        <option>Khoa Ch√¢m c·ª©u</option>
                        <option>Khoa PHCN</option>
			<option>Khoa D∆∞·ª£c</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-400 mb-1">M√¥ t·∫£ s·ª± c·ªë (ng·∫Øn g·ªçn)</label>
                    <textarea id="desc" required class="input-field h-12" placeholder="N√™u r√µ di·ªÖn bi·∫øn..."></textarea>
                </div>
                <div>
                    <label class="block text-xs font-semibold uppercase text-slate-400 mb-1">M·ª©c ƒë·ªô nguy c∆°</label>
                    <select id="level" class="input-field">
                        <option value="NC0">NC0 - Ch∆∞a x·∫£y ra</option>
                        <option value="NC1">NC1 - Nh·∫π</option>
                        <option value="NC2">NC2 - Trung b√¨nh</option>
                        <option value="NC3">NC3 - N·∫∑ng/T·ª≠ vong</option>
                    </select>
                </div>
                <button type="submit" id="btnSubmit" class="w-full bg-blue-600 hover:bg-blue-500 py-3 rounded-lg font-bold shadow-lg">G·ª¨I B√ÅO C√ÅO</button>
            </form>
        </div>

        <!-- DASHBOARD -->
        <div class="lg:col-span-3 space-y-4">
            <!-- Th·ªëng k√™ -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="card bg-blue-500/10 border-blue-500/30">
                    <p class="text-slate-300 text-xs font-semibold">T·ªîNG S·ª∞ C·ªê ƒê√É GHI NH·∫¨N</p>
                    <p id="stat-total" class="text-3xl font-bold text-blue-400">0</p>
                </div>
                <div class="card bg-red-500/10 border-red-500/30">
                    <p class="text-slate-300 text-xs font-semibold">S·ª∞ C·ªê NGHI√äM TR·ªåNG (NC3)</p>
                    <p id="stat-nc3" class="text-3xl font-bold text-red-500">0</p>
                </div>
                <div class="card bg-yellow-500/10 border-yellow-500/30">
                    <p class="text-slate-300 text-xs font-semibold">ƒê√É B√ÅO C√ÅO</p>
                    <p id="stat-pending" class="text-3xl font-bold text-yellow-500">0</p>
                </div>
                <div class="card bg-green-500/10 border-green-500/30">
                    <p class="text-slate-300 text-xs font-semibold">T·ª∂ L·ªÜ AN TO√ÄN S·ª∞ C·ªê</p>
                    <p id="stat-safe" class="text-3xl font-bold text-green-500">0%</p>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="card">
                    <h3 class="text-sm font-semibold mb-2 text-slate-400 uppercase text-center">Ph√¢n lo·∫°i theo m·ª©c ƒë·ªô nguy c∆°</h3>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
                <div class="card">
                    <h3 class="text-sm font-semibold mb-2 text-slate-400 uppercase text-center">Ph√¢n lo·∫°i s·ª± c·ªë theo khoa</h3>
                    <div class="chart-container">
                        <canvas id="barChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- SEARCH & LIST -->
            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <h2 class="text-lg font-semibold text-slate-300">Nh·∫≠t k√Ω b√°o c√°o g·∫ßn ƒë√¢y</h2>
                    <!-- √î T√¨m ki·∫øm -->
                    <input type="text" id="searchInput" 
                           placeholder="G√µ ƒë·ªÉ t√¨m: t√™n khoa, n·ªôi dung ho·∫∑c m·ª©c ƒë·ªô (NC3...)" 
                           class="input-field md:w-1/2 border-blue-500/50 focus:border-blue-400">
                </div>
                <div class="overflow-x-auto custom-scroll max-h-[400px]">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-slate-800 text-slate-400 sticky top-0">
                            <tr>
                                <th class="p-3">Th·ªùi gian</th>
                                <th class="p-3">Khoa</th>
                                <th class="p-3">M√¥ t·∫£ s·ª± c·ªë</th>
                                <th class="p-3">M·ª©c ƒë·ªô</th>
                                <th class="p-3">Tr·∫°ng th√°i</th>
                            </tr>
                        </thead>
                        <tbody id="table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzQ76wQcF0Q1yVpX9JSaHhBmlqzxuO6QsI-D4alBPI-2_5lqcfkFYAlhAnngIbB1kwOjw/exec";
        
        const app = {
            allData: [],
            barChart: null,
            pieChart: null,

            init: function() {
                setInterval(() => { 
                    document.getElementById('current-time').innerText = new Date().toLocaleString('vi-VN'); 
                }, 1000);

                this.fetchData();
                setInterval(() => this.fetchData(), 30000); // T·ª± ƒë·ªông l√†m m·ªõi m·ªói 30s

                // G·∫Øn s·ª± ki·ªán t√¨m ki·∫øm tr·ª±c ti·∫øp
                document.getElementById('searchInput').oninput = (e) => {
                    this.renderAll(e.target.value);
                };

                document.getElementById('incident-form').onsubmit = (e) => this.handleSubmit(e);
            },

            fetchData: async function() {
                try {
                    const response = await fetch(SCRIPT_URL);
                    const data = await response.json();
                    // Chu·∫©n h√≥a d·ªØ li·ªáu ngay khi nh·∫≠n ƒë·ªÉ thanh t√¨m ki·∫øm d·ªÖ l√†m vi·ªác
                    this.allData = data.map(item => ({
                        time: item.timestamp || "",
                        dept: item.department || item.khoa || "",
                        desc: item.description || item.m√¥_t·∫£ || "",
                        level: item.level || "NC0",
                        status: item.status || "M·ªõi"
                    }));
                    this.renderAll(document.getElementById('searchInput').value);
                } catch (error) {
                    console.error("L·ªói t·∫£i d·ªØ li·ªáu");
                }
            },

            handleSubmit: async function(e) {
                e.preventDefault();
                const btn = document.getElementById('btnSubmit');
                btn.innerText = "ƒêANG G·ª¨I...";
                btn.disabled = true;

                const payload = {
                    dept: document.getElementById('dept').value,
                    desc: document.getElementById('desc').value,
                    level: document.getElementById('level').value
                };

                try {
                    await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) });
                    alert("B√°o c√°o th√†nh c√¥ng!");
                    document.getElementById('incident-form').reset();
                    await this.fetchData();
                } catch (error) {
                    alert("L·ªói k·∫øt n·ªëi database!");
                } finally {
                    btn.innerText = "G·ª¨I B√ÅO C√ÅO";
                    btn.disabled = false;
                }
            },

            renderAll: function(filterText = "") {
                const search = filterText.toLowerCase().trim();
                
                // L·ªçc d·ªØ li·ªáu ch√≠nh x√°c
                const filtered = this.allData.filter(item => {
                    return item.dept.toLowerCase().includes(search) || 
                           item.desc.toLowerCase().includes(search) || 
                           item.level.toLowerCase().includes(search);
                });

                // C·∫≠p nh·∫≠t Th·ªëng k√™
                const total = filtered.length;
                const nc3 = filtered.filter(d => d.level === 'NC3').length;
                const pending = filtered.filter(d => d.status === 'M·ªõi').length;
                
                document.getElementById('stat-total').innerText = total;
                document.getElementById('stat-nc3').innerText = nc3;
                document.getElementById('stat-pending').innerText = pending;
                document.getElementById('stat-safe').innerText = total > 0 ? Math.round(((total-nc3)/total)*100) + '%' : '100%';

                // C·∫≠p nh·∫≠t B·∫£ng (S·∫Øp x·∫øp m·ªõi nh·∫•t l√™n ƒë·∫ßu)
                const tableBody = document.getElementById('table-body');
                if (filtered.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="5" class="p-10 text-center text-slate-500 italic">Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu ph√π h·ª£p</td></tr>`;
                } else {
                    tableBody.innerHTML = filtered.slice().reverse().map(item => `
                        <tr class="border-b border-slate-700 hover:bg-slate-800/50 transition">
                            <td class="p-3 text-[10px] text-slate-400">${item.time ? new Date(item.time).toLocaleString('vi-VN') : ''}</td>
                            <td class="p-3 font-semibold text-xs text-blue-300">${item.dept}</td>
                            <td class="p-3 text-slate-300 text-xs">${item.desc}</td>
                            <td class="p-3">
                                <span class="px-2 py-0.5 rounded text-[10px] font-bold ${item.level === 'NC3' ? 'bg-red-500/20 text-red-400' : 'bg-blue-500/20 text-blue-400'}">
                                    ${item.level}
                                </span>
                            </td>
                            <td class="p-3"><span class="text-[10px] italic text-yellow-500">${item.status}</span></td>
                        </tr>
                    `).join('');
                }

                this.updateCharts(filtered);
            },

            updateCharts: function(data) {
                const depts = {};
                const levels = { 'NC0': 0, 'NC1': 0, 'NC2': 0, 'NC3': 0 };
                
                data.forEach(d => {
                    depts[d.dept] = (depts[d.dept] || 0) + 1;
                    if (levels.hasOwnProperty(d.level)) levels[d.level]++;
                });

                if (this.barChart) this.barChart.destroy();
                if (this.pieChart) this.pieChart.destroy();

                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { labels: { color: '#cbd5e1', font: { size: 10 } } } }
                };

                this.barChart = new Chart(document.getElementById('barChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(depts),
                        datasets: [{ label: 'S·ªë v·ª•', data: Object.values(depts), backgroundColor: '#3b82f6' }]
                    },
                    options: { ...commonOptions, plugins: { legend: { display: false } }, 
                        scales: { y: { beginAtZero: true, grid: { color: '#334155' } } } 
                    }
                });

                this.pieChart = new Chart(document.getElementById('pieChart'), {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(levels),
                        datasets: [{
                            data: Object.values(levels),
                            backgroundColor: ['#64748b', '#22c55e', '#fbbf24', '#f87171'],
                            borderWidth: 0
                        }]
                    },
                    options: { ...commonOptions, plugins: { legend: { position: 'bottom', labels: { color: '#cbd5e1' } } } }
                });
            }
        };

        window.onload = () => app.init();
    </script>
</body>
</html>